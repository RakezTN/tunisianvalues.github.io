<!DOCTYPE html>
<html lang="fr">
<head>
<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:400,700" rel="stylesheet">
<link href="style.css" rel="stylesheet" type="text/css">
<title>TunisianValues — Résultats</title>
<link rel="icon" type="x-icon" href="icon.png">
<meta charset="utf-8">
<script> version = "Bêta" </script>
</head>

<script type="application/javascript" src="ideologies.js"></script>

<body>
<h1>TunisianValues</h1>
<hr>

<h1>Résultats</h1>

<!-- Axe Panarabisme ↔ Nationalisme tunisien -->
<h2>Axe Panarabisme : <span class="weight-300" id="pana-label"></span></h2>
<div class="axis">
    <img id="img-left-pana" src="value_images/pan_arabisme.svg" height="128pt" alt="Panarabisme"/>
    <div class="bar left-pana" id="bar-left-pana"><div class="text-wrapper" id="left-pana"></div></div>
    <div class="bar right-pana" id="bar-right-pana"><div class="text-wrapper" id="right-pana"></div></div>
    <img id="img-right-pana" src="value_images/nationalisme.svg" height="128pt" alt="Nationalisme tunisien"/>
</div>

<!-- Axe Coopération internationale ↔ Isolationnisme -->
<h2>Axe Coopération internationale : <span class="weight-300" id="coop-label"></span></h2>
<div class="axis">
    <img id="img-left-coop" src="value_images/cooperation.svg" height="128pt" alt="Coopération internationale"/>
    <div class="bar left-coop" id="bar-left-coop"><div class="text-wrapper" id="left-coop"></div></div>
    <div class="bar right-coop" id="bar-right-coop"><div class="text-wrapper" id="right-coop"></div></div>
    <img id="img-right-coop" src="value_images/isolation.svg" height="128pt" alt="Isolationnisme"/>
</div>

<!-- Axe Socialisme ↔ Capitalisme -->
<h2>Axe Économie : <span class="weight-300" id="econ-label"></span></h2>
<div class="axis">
    <img id="img-left-econ" src="value_images/socialisme.svg" height="128pt" alt="Socialisme"/>
    <div class="bar left-econ" id="bar-left-econ"><div class="text-wrapper" id="left-econ"></div></div>
    <div class="bar right-econ" id="bar-right-econ"><div class="text-wrapper" id="right-econ"></div></div>
    <img id="img-right-econ" src="value_images/capitalisme.svg" height="128pt" alt="Capitalisme"/>
</div>

<!-- Axe Islamisme ↔ Laïcisme -->
<h2>Axe Religion : <span class="weight-300" id="reli-label"></span></h2>
<div class="axis">
    <img id="img-left-reli" src="value_images/islamisme.svg" height="128pt" alt="Islamisme"/>
    <div class="bar left-reli" id="bar-left-reli"><div class="text-wrapper" id="left-reli"></div></div>
    <div class="bar right-reli" id="bar-right-reli"><div class="text-wrapper" id="right-reli"></div></div>
    <img id="img-right-reli" src="value_images/laicisme.svg" height="128pt" alt="Laïcisme"/>
</div>

<!-- Axe Conservatisme ↔ Progressisme -->
<h2>Axe Sociétal : <span class="weight-300" id="soci-label"></span></h2>
<div class="axis">
    <img id="img-left-soci" src="value_images/conservatisme.svg" height="128pt" alt="Conservatisme"/>
    <div class="bar left-soci" id="bar-left-soci"><div class="text-wrapper" id="left-soci"></div></div>
    <div class="bar right-soci" id="bar-right-soci"><div class="text-wrapper" id="right-soci"></div></div>
    <img id="img-right-soci" src="value_images/progressisme.svg" height="128pt" alt="Progressisme"/>
</div>

<!-- Axe Démocratie ↔ Autoritarisme -->
<h2>Axe Gouvernance : <span class="weight-300" id="demo-label"></span></h2>
<div class="axis">
    <img id="img-left-demo" src="value_images/democratie.svg" height="128pt" alt="Démocratie"/>
    <div class="bar left-demo" id="bar-left-demo"><div class="text-wrapper" id="left-demo"></div></div>
    <div class="bar right-demo" id="bar-right-demo"><div class="text-wrapper" id="right-demo"></div></div>
    <img id="img-right-demo" src="value_images/autoritarisme.svg" height="128pt" alt="Autoritarisme"/>
</div>

<!-- Axe Décentralisation ↔ Centralisation -->
<h2>Axe Décentralisation : <span class="weight-300" id="decent-label"></span></h2>
<div class="axis">
    <img id="img-left-decent" src="value_images/decentralisation.svg" height="128pt" alt="Décentralisation"/>
    <div class="bar left-decent" id="bar-left-decent"><div class="text-wrapper" id="left-decent"></div></div>
    <div class="bar right-decent" id="bar-right-decent"><div class="text-wrapper" id="right-decent"></div></div>
    <img id="img-right-decent" src="value_images/centralisation.svg" height="128pt" alt="Centralisation"/>
</div>
<hr/>

<!-- NOUVEAU : SECTION POUR LES ICÔNES SPÉCIALES -->
<div id="special-icons-container" style="text-align:center; padding: 10px 0;">
    <!-- Les icônes créées par le script apparaîtront ici -->
</div>

<h2>Profil le plus proche : <span id="ideology-label" class="weight-300"></span></h2>
<img src="" id="banner" alt="Bannière de résultats">
<button class="button" onclick="location.href='index.html';">Retour</button> <br>

<script type="text/javascript">
var sc_project=11325211;
var sc_invisible=1;
var sc_security="fd9f0659";
var scJsHost = (("https:" == document.location.protocol) ? "https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" + scJsHost+ "statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="web stats" href="http://statcounter.com/" target="_blank"><img class="statcounter" src="//c.statcounter.com/11325211/0/fd9f0659/1/" alt="web stats"></a></div></noscript>

<script>
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (decodeURIComponent(pair[0]) == variable) {
                return decodeURIComponent(pair[1]);
            }
        }
        return null; // Renvoie null si la variable n'est pas trouvée
    }

    function setBarValue(name, value) {
        var innerel = document.getElementById(name);
        var outerel = document.getElementById("bar-" + name);
        if (!isNaN(value)) {
            outerel.style.width = (value + "%");
            innerel.innerHTML = (value + "%");
            if (innerel.offsetWidth + 20 > outerel.offsetWidth) {
                innerel.style.visibility = "hidden";
            }
        }
    }

    // Labels pour les axes
    var panaLabels = ["Nationalisme Arabe","Panarabisme","Arabisme","Patriotisme","Nationalisme Tunisien"];
    var coopLabels = ["Internationalisme","Multilatéralisme","Neutralité","Isolationnisme","Autarcie"];
    var econLabels = ["Socialisme","Social-démocratie","Interventioniste","Social-Libéralisme","Libéralisme"];
    var reliLabels = ["Islamisme","Islam culturel","Statut-Quo","Sécularisme","Laïcité"];
    var sociLabels = ["Conservatisme","Libéral-Conservateur","Libéral","Modernisme","Progressisme"];
    var demoLabels = ["Démocratie participative","Démocratie libérale","État de droit","Autoritarisme","Totalitarisme"];
    var decentLabels = ["Fédéralisme","Régionalisme","Décentralisation","Centralisation","Unitarisme"];

    // Lecture des scores depuis URL
    var pana = parseFloat(getQueryVariable("pana"));
    var coop = parseFloat(getQueryVariable("coop"));
    var econ = parseFloat(getQueryVariable("econ"));
    var reli = parseFloat(getQueryVariable("reli"));
    var soci = parseFloat(getQueryVariable("soci"));
    var demo = parseFloat(getQueryVariable("demo"));
    var decent = parseFloat(getQueryVariable("decent"));

    // NOUVEAU : Lecture et affichage des icônes
    const icons_param = getQueryVariable("icons");
    if (icons_param && icons_param.length > 0) {
        const container = document.getElementById("special-icons-container");
        const icons = icons_param.split(',');
        
        const title = document.createElement('h2');
        title.innerText = "Positions Particulières";
        title.className = "weight-300";
        container.appendChild(title);

        icons.forEach(iconId => {
            if (iconId) {
                const img = document.createElement('img');
                img.src = `icons/${iconId}.png`;
                img.title = iconId;
                img.style.height = '60px';
                img.style.width = '60px';
                img.style.margin = '5px 10px';
                container.appendChild(img);
            }
        });
    }

    // Calcul des valeurs droites
    var panaR = 100 - pana; var coopR = 100 - coop; var econR = 100 - econ;
    var reliR = 100 - reli; var sociR = 100 - soci; var demoR = 100 - demo;
    var decentR = 100 - decent;

    // Affichage des barres
    setBarValue("left-pana", pana); setBarValue("right-pana", panaR);
    setBarValue("left-coop", coop); setBarValue("right-coop", coopR);
    setBarValue("left-econ", econ); setBarValue("right-econ", econR);
    setBarValue("left-reli", reli); setBarValue("right-reli", reliR);
    setBarValue("left-soci", soci); setBarValue("right-soci", sociR);
    setBarValue("left-demo", demo); setBarValue("right-demo", demoR);
    setBarValue("left-decent", decent); setBarValue("right-decent", decentR);

    // Fonction pour choisir le label
    function pickLabel(val, labels) {
        if (val >= 80) return labels[0];
        else if (val >= 60) return labels[1];
        else if (val >= 40) return labels[2];
        else if (val >= 20) return labels[3];
        else return labels[4];
    }

    // Affichage des labels
    document.getElementById("pana-label").innerHTML = pickLabel(pana, panaLabels);
    document.getElementById("coop-label").innerHTML = pickLabel(coop, coopLabels);
    document.getElementById("econ-label").innerHTML = pickLabel(econ, econLabels);
    document.getElementById("reli-label").innerHTML = pickLabel(reli, reliLabels);
    document.getElementById("soci-label").innerHTML = pickLabel(soci, sociLabels);
    document.getElementById("demo-label").innerHTML = pickLabel(demo, demoLabels);
    document.getElementById("decent-label").innerHTML = pickLabel(decent, decentLabels);

    // Calcul du profil le plus proche
    var ideology = "";
    var ideodist = Infinity;
    for (var i = 0; i < ideologies.length; i++) {
        var dist = 0;
        dist += Math.pow(Math.abs(ideologies[i].stats.pana - pana), 2);
        dist += Math.pow(Math.abs(ideologies[i].stats.coop - coop), 2);
        dist += Math.pow(Math.abs(ideologies[i].stats.econ - econ), 2);
        dist += Math.pow(Math.abs(ideologies[i].stats.reli - reli), 2);
        dist += Math.pow(Math.abs(ideologies[i].stats.soci - soci), 2);
        dist += Math.pow(Math.abs(ideologies[i].stats.demo - demo), 2);
        dist += Math.pow(Math.abs(ideologies[i].stats.decent - decent), 2);
        if (dist < ideodist) {
            ideology = ideologies[i].name;
            ideodist = dist;
        }
    }
    document.getElementById("ideology-label").innerHTML = ideology;

// CETTE PARTIE EST MAINTENANT COMPLÈTE ET INTacte
window.onload = function() {
    // Helper to load images from the DOM, essential for canvas drawing.
    function loadImageFromDom(id) {
        return new Promise(function(resolve) {
            var dom = document.getElementById(id);
            var img = new Image();
            if (!dom || !dom.src) {
                console.warn("Image element not found or has no src:", id);
                img.src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="; // Fallback
                img.onload = () => resolve(img);
                img.onerror = () => resolve(img);
                return;
            }
            img.onload = () => resolve(img);
            img.onerror = () => {
                console.error("Failed to load image:", dom.src);
                resolve(img);
            };
            img.src = dom.src;
        });
    }

    var imageIds = [
      "img-left-pana", "img-right-pana", "img-left-coop", "img-right-coop",
      "img-left-econ", "img-right-econ", "img-left-reli", "img-right-reli",
      "img-left-soci", "img-right-soci", "img-left-demo", "img-right-demo",
      "img-left-decent", "img-right-decent"
    ];

    // Wait for fonts and images to be fully loaded before drawing
    Promise.all([document.fonts.ready, Promise.all(imageIds.map(loadImageFromDom))]).then(function(results) {
        var imagesArray = results[1];
        var imgs = {};
        for (var i = 0; i < imageIds.length; i++) imgs[imageIds[i]] = imagesArray[i];

        // --- CANVAS SETUP ---
        var c = document.createElement("canvas");
        var ctx = c.getContext("2d");
        c.width = 900;
        c.height = 950; // Increased height for better spacing

        ctx.fillStyle = "#EEEEEE";
        ctx.fillRect(0, 0, c.width, c.height);

        // --- LAYOUT CONSTANTS (METICULOUSLY ADJUSTED) ---
        var iconSize = 80; // Reduced icon size
        var barHeight = 40; // Adjusted bar height
        var barStartX = 135;
        var barTotalWidth = 630;
        var startY = 220; // Pushed everything down
        var gap = 100; // Space between each axis

        // --- MAIN TITLES ---
        ctx.fillStyle = "#222222";
        ctx.font = "700 60px Montserrat";
        ctx.textAlign = "left";
        ctx.fillText("TunisianValues", 20, 80);
        ctx.font = "50px Montserrat";
        ctx.fillText(ideology, 20, 145);

        // --- FOOTER TEXT ---
        ctx.textAlign = "right";
        ctx.font = "300 25px Montserrat";
        ctx.fillText("tunisianvalues", 880, 60);
        ctx.font = "300 25px Montserrat";
        ctx.fillText("Bêta", 880, 90);

        // --- TEXT LABELS FOR ICONS (THIS WAS MISSING) ---
        const leftLabels = ["PANARABISME", "MULTILATERALISME", "SOCIALISME", "ISLAM POLITIQUE", "CONSERVATISME", "DEMOCRATIE", "DECENTRALISATION"];
        const rightLabels = ["NATIONALISME", "ISOLATIONNISME", "CAPITALISME", "SÉCULARISME", "PROGRESSISME", "AUTORITARISME", "CENTRALISME"];

        // Arrays of values and colors for looping
        const vals = [pana, coop, econ, reli, soci, demo, decent];
        const valsR = [panaR, coopR, econR, reliR, sociR, demoR, decentR];
        const leftColors = ["#f44336", "#ff9800", "#ffeb3b", "#9c27b0", "#8bc34a", "#ff5722", "#00bcd4"];
        const rightColors = ["#00897b", "#03a9f4", "#3f51b5", "#673ab7", "#e91e63", "#795548", "#009688"]; // Corrected Progressisme color to pink

        // --- MASTER LOOP TO DRAW EVERYTHING ---
        for (let i = 0; i < 7; i++) {
            let currentY = startY + i * gap;

            // 1. Draw Axis Title (e.g., "Panarabisme vs Nationalisme tunisien")
            ctx.fillStyle = "#222222";
            ctx.font = "300 28px Montserrat";
            ctx.textAlign = "center";
            ctx.fillText(document.querySelectorAll("h2")[i].textContent.split(':')[1].trim(), 450, currentY - 30);

            // 2. Draw Icons
            ctx.drawImage(imgs[imageIds[i*2]], 30, currentY - iconSize/2, iconSize, iconSize);
            ctx.drawImage(imgs[imageIds[i*2+1]], 790, currentY - iconSize/2, iconSize, iconSize);

            // 3. Draw Icon Labels (The missing part)
            ctx.fillStyle = "#222222";
            ctx.font = "bold 12px Montserrat";
            ctx.textAlign = "center";
            ctx.fillText(leftLabels[i], 30 + iconSize/2, currentY + iconSize/2 + 15);
            ctx.fillText(rightLabels[i], 790 + iconSize/2, currentY + iconSize/2 + 15);
            
            // 4. Draw Background Bar
            ctx.fillStyle = "#222222";
            ctx.fillRect(barStartX, currentY - barHeight/2, barTotalWidth, barHeight);

            // 5. Draw Left and Right Value Bars
            let leftWidth = (vals[i] / 100) * barTotalWidth;
            let rightWidth = (valsR[i] / 100) * barTotalWidth;
            
            ctx.fillStyle = leftColors[i];
            ctx.fillRect(barStartX + 2, currentY - barHeight/2 + 2, leftWidth - 4, barHeight - 4);
            ctx.fillStyle = rightColors[i];
            ctx.fillRect(barStartX + leftWidth + 2, currentY - barHeight/2 + 2, rightWidth - 4, barHeight - 4);
            
            // 6. Draw Percentage Text (Correctly centered)
            ctx.fillStyle = "#FFFFFF";
            ctx.font = "bold 24px Montserrat";
            ctx.textAlign = "left";
            if (leftWidth > 50) {
                 ctx.fillText(Math.round(vals[i]) + "%", barStartX + 10, currentY + 8);
            }
            ctx.textAlign = "right";
            if (rightWidth > 50) {
                ctx.fillText(Math.round(valsR[i]) + "%", barStartX + barTotalWidth - 10, currentY + 8);
            }
        }

        // --- FINAL EXPORT ---
        document.getElementById("banner").src = c.toDataURL();

    }).catch(function(err) {
        console.error("Fatal error during canvas rendering:", err);
    });
};
</script>
</body>
</html>
